package com.spark.service;

import java.util.HashMap;
import java.util.Map;
import java.util.Optional;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.http.ResponseEntity;
import org.springframework.security.crypto.password.PasswordEncoder;
import org.springframework.stereotype.Service;
import com.spark.Entity.UserEntity;
import com.spark.dto.UserDTO;
import com.spark.repository.UserRepository;
import jakarta.persistence.EntityManager;
import jakarta.persistence.PersistenceContext;
import jakarta.transaction.Transactional;

@Service
@Transactional
public class UserService {
    @Autowired
    private UserRepository userRepo;
    
    @Autowired
    private PasswordEncoder pwencoder;
    
    // âœ… EntityManager ì¶”ê°€ - ì§ì ‘ persist ì‚¬ìš©
    @PersistenceContext
    private EntityManager entityManager;
    
    // í•™ìƒ íšŒì›ê°€ì…
    public ResponseEntity<?> createStudent(UserDTO request) {
        try {
            System.out.println("=== í•™ìƒ íšŒì›ê°€ì… ì‹œì‘ ===");
            System.out.println("ë°›ì€ ë°ì´í„° í™•ì¸:");
            System.out.println("ì•„ì´ë””: " + request.getUser_id());
            System.out.println("ë¹„ë°€ë²ˆí˜¸: " + (request.getPw() != null ? "***ìˆìŒ***" : "NULL"));
            System.out.println("ì´ë¦„: " + request.getName());
            System.out.println("ì´ë©”ì¼: " + request.getEmail());
            
            // ğŸš¨ ì¤‘ìš”: ë¹„ë°€ë²ˆí˜¸ ê²€ì¦
            if (request.getPw() == null || request.getPw().trim().isEmpty()) {
                Map<String, Object> response = new HashMap<>();
                response.put("success", false);
                response.put("message", "ë¹„ë°€ë²ˆí˜¸ëŠ” í•„ìˆ˜ì…ë‹ˆë‹¤.");
                return ResponseEntity.badRequest().body(response);
            }
            
            if (!request.isPasswordValid()) {
                Map<String, Object> response = new HashMap<>();
                response.put("success", false);
                response.put("message", "ë¹„ë°€ë²ˆí˜¸ëŠ” 8ì ì´ìƒì´ì–´ì•¼ í•©ë‹ˆë‹¤.");
                return ResponseEntity.badRequest().body(response);
            }
            
            if (!request.isPasswordMatching()) {
                Map<String, Object> response = new HashMap<>();
                response.put("success", false);
                response.put("message", "ë¹„ë°€ë²ˆí˜¸ê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.");
                return ResponseEntity.badRequest().body(response);
            }
            
            if (request.getUser_id() == null || request.getUser_id().trim().isEmpty()) {
                Map<String, Object> response = new HashMap<>();
                response.put("success", false);
                response.put("message", "ì•„ì´ë””ëŠ” í•„ìˆ˜ì…ë‹ˆë‹¤.");
                return ResponseEntity.badRequest().body(response);
            }
            
            if (request.getName() == null || request.getName().trim().isEmpty()) {
                Map<String, Object> response = new HashMap<>();
                response.put("success", false);
                response.put("message", "ì´ë¦„ì€ í•„ìˆ˜ì…ë‹ˆë‹¤.");
                return ResponseEntity.badRequest().body(response);
            }
            
            if (request.getEmail() == null || request.getEmail().trim().isEmpty()) {
                Map<String, Object> response = new HashMap<>();
                response.put("success", false);
                response.put("message", "ì´ë©”ì¼ì€ í•„ìˆ˜ì…ë‹ˆë‹¤.");
                return ResponseEntity.badRequest().body(response);
            }
            
            // âœ… ì¤‘ë³µ ê²€ì‚¬ë¥¼ í•œ ë²ˆë§Œ ìˆ˜í–‰
            Optional<UserEntity> existingUser = userRepo.findByUserId(request.getUser_id());
            if (existingUser.isPresent()) {
                Map<String, Object> response = new HashMap<>();
                response.put("success", false);
                response.put("message", "ì´ë¯¸ ì¡´ì¬í•˜ëŠ” ì•„ì´ë””ì…ë‹ˆë‹¤");
                return ResponseEntity.badRequest().body(response);
            }
            
            if (userRepo.existsByEmail(request.getEmail())) {
                Map<String, Object> response = new HashMap<>();
                response.put("success", false);
                response.put("message", "ì´ë¯¸ ì¡´ì¬í•˜ëŠ” ì´ë©”ì¼ì…ë‹ˆë‹¤");
                return ResponseEntity.badRequest().body(response);
            }
            
            // ë¹„ë°€ë²ˆí˜¸ ì•”í˜¸í™”
            System.out.println("ë¹„ë°€ë²ˆí˜¸ ì•”í˜¸í™” ì‹œì‘...");
            String encodedPassword = pwencoder.encode(request.getPw());
            System.out.println("ë¹„ë°€ë²ˆí˜¸ ì•”í˜¸í™” ì™„ë£Œ");
            
            // âœ… ìƒˆë¡œìš´ Entity ìƒì„± - merge ëŒ€ì‹  persist ì‚¬ìš©
            UserEntity student = new UserEntity();
            student.setUserId(request.getUser_id());
            student.setPw(encodedPassword);
            student.setName(request.getName());
            student.setAddress1(request.getAddress1());
            student.setAddress2(request.getAddress2());
            student.setAddressnum(request.getAdressnum());
            student.setBirthday(request.getBirthday());
            student.setPhone(request.getPhone());
            student.setEmail(request.getEmail());
            student.setPosition("1");  // í•™ìƒ
            
            System.out.println("Entity ìƒì„± ì™„ë£Œ: " + student.getUserId());
            
            // ğŸ¯ í•µì‹¬: EntityManager.persist ì‚¬ìš© (merge ë°©ì§€)
            try {
                entityManager.persist(student);
                entityManager.flush(); // ì¦‰ì‹œ DBì— ë°˜ì˜
                System.out.println("=== í•™ìƒ íšŒì›ê°€ì… ì™„ë£Œ ===");
                
                Map<String, Object> response = new HashMap<>();
                response.put("success", true);
                response.put("message", "ìˆ˜ê°•ìƒ íšŒì›ê°€ì…ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!");
                response.put("userId", student.getUserId());
                response.put("userRole", "STUDENT");
                
                return ResponseEntity.ok(response);
                
            } catch (Exception persistException) {
                System.err.println("ì €ì¥ ì¤‘ ì˜¤ë¥˜: " + persistException.getMessage());
                Map<String, Object> response = new HashMap<>();
                response.put("success", false);
                response.put("message", "ì•„ì´ë””ê°€ ì´ë¯¸ ì¡´ì¬í•˜ê±°ë‚˜ ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
                return ResponseEntity.badRequest().body(response);
            }
            
        } catch (Exception e) {
            e.printStackTrace();
            Map<String, Object> response = new HashMap<>();
            response.put("success", false);
            response.put("message", "ì„œë²„ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: " + e.getMessage());
            return ResponseEntity.internalServerError().body(response);
        }
    }
    
    // ê°•ì‚¬ íšŒì›ê°€ì…
    public ResponseEntity<?> createInstructor(UserDTO request) {
        try {
            System.out.println("=== ê°•ì‚¬ íšŒì›ê°€ì… ì‹œì‘ ===");
            System.out.println("ë°›ì€ ë°ì´í„° í™•ì¸:");
            System.out.println("ì•„ì´ë””: " + request.getUser_id());
            System.out.println("ë¹„ë°€ë²ˆí˜¸: " + (request.getPw() != null ? "***ìˆìŒ***" : "NULL"));
            
            // ê²€ì¦ ë¡œì§ë“¤...
            if (request.getPw() == null || request.getPw().trim().isEmpty()) {
                Map<String, Object> response = new HashMap<>();
                response.put("success", false);
                response.put("message", "ë¹„ë°€ë²ˆí˜¸ëŠ” í•„ìˆ˜ì…ë‹ˆë‹¤.");
                return ResponseEntity.badRequest().body(response);
            }
            
            if (!request.isPasswordValid()) {
                Map<String, Object> response = new HashMap<>();
                response.put("success", false);
                response.put("message", "ë¹„ë°€ë²ˆí˜¸ëŠ” 8ì ì´ìƒì´ì–´ì•¼ í•©ë‹ˆë‹¤.");
                return ResponseEntity.badRequest().body(response);
            }
            
            if (!request.isPasswordMatching()) {
                Map<String, Object> response = new HashMap<>();
                response.put("success", false);
                response.put("message", "ë¹„ë°€ë²ˆí˜¸ê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.");
                return ResponseEntity.badRequest().body(response);
            }
            
            // ì¤‘ë³µ ê²€ì‚¬
            Optional<UserEntity> existingUser = userRepo.findByUserId(request.getUser_id());
            if (existingUser.isPresent()) {
                Map<String, Object> response = new HashMap<>();
                response.put("success", false);
                response.put("message", "ì´ë¯¸ ì¡´ì¬í•˜ëŠ” ì•„ì´ë””ì…ë‹ˆë‹¤");
                return ResponseEntity.badRequest().body(response);
            }
            
            if (userRepo.existsByEmail(request.getEmail())) {
                Map<String, Object> response = new HashMap<>();
                response.put("success", false);
                response.put("message", "ì´ë¯¸ ì¡´ì¬í•˜ëŠ” ì´ë©”ì¼ì…ë‹ˆë‹¤");
                return ResponseEntity.badRequest().body(response);
            }
            
            // ë¹„ë°€ë²ˆí˜¸ ì•”í˜¸í™”
            String encodedPassword = pwencoder.encode(request.getPw());
            
            UserEntity teacher = new UserEntity();
            teacher.setUserId(request.getUser_id());
            teacher.setPw(encodedPassword);
            teacher.setName(request.getName());
            teacher.setAddress1(request.getAddress1());
            teacher.setAddress2(request.getAddress2());
            teacher.setAddressnum(request.getAdressnum());
            teacher.setBirthday(request.getBirthday());
            teacher.setPhone(request.getPhone());
            teacher.setEmail(request.getEmail());
            teacher.setPosition("2");  // ê°•ì‚¬
            
            // EntityManager.persist ì‚¬ìš©
            try {
                entityManager.persist(teacher);
                entityManager.flush();
                System.out.println("=== ê°•ì‚¬ íšŒì›ê°€ì… ì™„ë£Œ ===");
                
                Map<String, Object> response = new HashMap<>();
                response.put("success", true);
                response.put("message", "ê°•ì‚¬ íšŒì›ê°€ì…ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!");
                response.put("userId", teacher.getUserId());
                response.put("userRole", "INSTRUCTOR");
                
                return ResponseEntity.ok(response);
                
            } catch (Exception persistException) {
                System.err.println("ì €ì¥ ì¤‘ ì˜¤ë¥˜: " + persistException.getMessage());
                Map<String, Object> response = new HashMap<>();
                response.put("success", false);
                response.put("message", "ì•„ì´ë””ê°€ ì´ë¯¸ ì¡´ì¬í•˜ê±°ë‚˜ ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
                return ResponseEntity.badRequest().body(response);
            }
            
        } catch (Exception e) {
            e.printStackTrace();
            Map<String, Object> response = new HashMap<>();
            response.put("success", false);
            response.put("message", "íšŒì›ê°€ì… ì‹¤íŒ¨: " + e.getMessage());
            return ResponseEntity.status(500).body(response);
        }
    }
    
    public ResponseEntity<?> checkUserIdAvailability(String userId) {
        Map<String, Object> response = new HashMap<>();
        
        try {
            Optional<UserEntity> existingUser = userRepo.findByUserId(userId);
            boolean available = !existingUser.isPresent();
            
            response.put("available", available);
            response.put("message", available ? "ì‚¬ìš© ê°€ëŠ¥í•œ ì•„ì´ë””ì…ë‹ˆë‹¤." : "ì´ë¯¸ ì‚¬ìš© ì¤‘ì¸ ì•„ì´ë””ì…ë‹ˆë‹¤.");
            
            return ResponseEntity.ok(response);
        } catch (Exception e) {
            e.printStackTrace();
            response.put("available", false);
            response.put("message", "ì•„ì´ë”” í™•ì¸ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
            return ResponseEntity.internalServerError().body(response);
        }
    }
    
    public ResponseEntity<?> checkEmailAvailability(String email) {
        Map<String, Object> response = new HashMap<>();
        
        try {
            boolean available = !userRepo.existsByEmail(email);
            
            response.put("available", available);
            response.put("message", available ? "ì‚¬ìš© ê°€ëŠ¥í•œ ì´ë©”ì¼ì…ë‹ˆë‹¤." : "ì´ë¯¸ ì‚¬ìš© ì¤‘ì¸ ì´ë©”ì¼ì…ë‹ˆë‹¤.");
            
            return ResponseEntity.ok(response);
        } catch (Exception e) {
            e.printStackTrace();
            response.put("available", false);
            response.put("message", "ì´ë©”ì¼ í™•ì¸ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
            return ResponseEntity.internalServerError().body(response);
        }
    }
}